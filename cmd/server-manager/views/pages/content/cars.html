{{ define "title" }}Cars{{ end }}

{{ define "content" }}
    <h1 class="text-center">Cars &amp; Setups</h1>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link {{ if not .ShowSetups }}active{{ end }}" id="cars-tab" data-toggle="tab" href="#cars" role="tab" aria-controls="cars" aria-selected="true">
                Cars
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {{ if .ShowSetups }}active{{ end }}" id="setups-tab" data-toggle="tab" href="#setups" role="tab" aria-controls="setups" aria-selected="false">
                Setups
            </a>
        </li>
    </ul>

    <div class="tab-content mt-4" id="myTabContent">
        <div class="tab-pane fade {{ if not .ShowSetups }}show active{{ end }}" id="cars" role="tabpanel" aria-labelledby="cars-tab">

            {{ if WriteAccess }}
                <div class="card mb-3">
                    <div class="card-header"><strong>Upload a New Car</strong></div>
                    <div class="card-body">
                        <p class="card-text">You can upload multiple cars at once by placing them in a folder named "cars" and uploading
                            the whole folder. The upload process will only take the files that the server requires, and so should
                            not take too long.</p>

                        <p class="card-text">First choose the correct car folder (or containing folder) using the Choose a Folder
                            button below then use the Upload Cars button to upload your cars if the preview information appears
                            correctly.</p>

                        <p class="card-text mb-0">The drag and drop input accepts a single car folder, multiple car folders
                            or a cars folder containing multiple cars!</p>

                        <form class="d-inline">
                            <div class="mt-3 mb-3">
                                <div class="btn-file btn btn-secondary d-inline-block align-top">
                                    Choose a Folder
                                    <input id="input-folder-car" name="input-folder-car[]" type="file"
                                           multiple webkitdirectory value="Choose Folder" onchange="handleCarFiles(this.files)"/>
                                </div>

                                <div id="drop-zone" ondrop="handleCarDropFiles(event);" ondragover="dragOverHandler(event);" ondragleave="dragOutHandler(event);"
                                     class="ml-2 mr-2 drop-zone d-inline-block">Or Drag & Drop Folder(s) Here</div>

                                <div id="upload-button"></div>
                            </div>

                            <div class="progress" style="display: none;">
                                <div class="progress-bar" id="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="car-fail"></div>
                <div id="car-info-panel"></div>
            {{ end }}

            {{ $writeAccess := WriteAccess }}

            <table class="table table-bordered table-striped">
                <tr>
                    <th>#</th>
                    <th>Car Name</th>
                    <th>Tyres</th>
                    <th>Skins</th>
                    {{ if DeleteAccess }}
                        <th class="text-center">Delete</th>
                    {{ end }}
                </tr>
                {{ range $i, $car := .CarOpts }}
                    <tr>
                        <td>
                            {{ $i }}
                        </td>
                        <td>
                            <abbr title="{{ $car.Name }}">{{ prettify $car.Name true }}</abbr>
                        </td>
                        <td style="min-width: 120px;">
                            <small>
                                {{ range $tyreShort, $tyreLong := $car.Tyres }}
                                    {{ $tyreLong }} ({{ $tyreShort }})<br>
                                {{ end }}
                            </small>
                        </td>
                        <td>
                            <small>
                                {{ carList ($car.Skins | join ";")}}
                            </small>
                        </td>

                        {{ if DeleteAccess }}
                            <td class="text-center">
                                <a href="{{ print "/car/delete/" $car.Name }}"><i class="fas fa-trash text-danger"></i></a>
                            </td>
                        {{ end }}
                    </tr>
                {{ end }}
            </table>

            <div class="clearfix"></div>
        </div>
        <div class="tab-pane fade {{ if .ShowSetups }}show active{{ end }}" id="setups" role="tabpanel" aria-labelledby="setups-tab">

            {{ if WriteAccess }}
                <form method="post" action="/setups/upload"  enctype="multipart/form-data">
                    <div class="card mb-3">
                        <div class="card-header"><strong>Upload a New Setup</strong></div>
                        <div class="card-body">

                            <div class="form-group row">
                                <label for="Track" class="col-sm-3 col-form-label">
                                    Track
                                </label>

                                <div class="col-sm-9">
                                    <select class="form-control" name="Track" id="Track">
                                        <option value="generic">Generic</option>

                                        {{ range $index, $track := .TrackOpts }}
                                            <option value="{{ $track.Name }}">
                                                {{ prettify $track.Name false }}
                                            </option>
                                        {{ end }}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label for="SetupFile" class="col-sm-3 col-form-label">
                                    Setup File
                                </label>

                                <div class="col-sm-9">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="SetupFile" name="SetupFile" accept=".ini">
                                        <label class="custom-file-label" for="SetupFile">Choose Setup</label>
                                    </div>
                                </div>
                            </div>

                            <p>The car model is determined automatically from the uploaded file.</p>

                            <button type="submit" class="btn btn-success float-right">Upload Setup</button>
                        </div>
                    </div>
                </form>

            {{ end }}

            <table class="table table-bordered table-striped">
                <tr>
                    <th>Car</th>
                    <th>Track</th>
                    <th>Setup File</th>
                    {{ if DeleteAccess }}
                        <th class="text-center">Delete</th>
                    {{ end }}
                </tr>

                {{ range $car, $tracks := .FixedSetups }}
                    {{ $setupIndex := 0 }}
                    {{ $numSetupsForCar := 0}}

                    {{ range $trackName, $setups := $tracks }}
                        {{ range $index, $setup := $setups }}
                            {{ $numSetupsForCar = add $numSetupsForCar 1 }}
                        {{ end }}
                    {{ end }}

                    {{ range $trackName, $setups := $tracks }}
                        {{ range $index, $setup := $setups }}
                            <tr>

                                {{ if eq $setupIndex 0 }}
                                    <td rowspan="{{ $numSetupsForCar }}">
                                        <abbr title="{{ $car }}">{{ prettify $car true }}</abbr>
                                    </td>
                                {{ end }}

                                {{ if eq $index 0 }}
                                    <td rowspan="{{ len $setups }}">
                                        {{ prettify $trackName false }}
                                    </td>
                                {{ end }}

                                <td>
                                    <a href="{{ printf "/setups/download/%s/%s/%s" $car $trackName $setup }}">
                                        {{ $setup }}
                                    </a>
                                </td>

                                {{ if DeleteAccess }}
                                    <td class="text-center">
                                        <a href="{{ printf "/setups/delete/%s/%s/%s" $car $trackName $setup }}"><i class="fas fa-trash text-danger"></i></a>
                                    </td>
                                {{ end }}
                            </tr>

                            {{ $setupIndex = (add $setupIndex 1) }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            </table>

            <div class="clearfix"></div>
        </div>
    </div>

{{ end }}
