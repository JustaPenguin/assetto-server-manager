language: go
go:
  - 1.11

sudo: required

before_install:
  - nvm install 11
  - nvm use 11

install:
  - node -v
  - git --version
  - go version

script:
  - export GO111MODULE=on
  - mkdir -p cmd/server-manager/assetto/{cfg,results}
  - cp -R fixtures/results/*.json cmd/server-manager/assetto/results
  - go test

  # windows icon
  - go get -u github.com/akavel/rsrc
  - rsrc -ico misc/windows/icon.ico -arch amd64 -o ./cmd/server-manager/rsrc.syso

  - cd cmd/server-manager
  - cp config.example.yml config.yml

  - npm install
  - node_modules/.bin/babel javascript/manager.js -o static/manager.js

  # asset embed
  - go get -u github.com/mjibson/esc
  - go generate ./...

  - GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X github.com/cj123/assetto-server-manager.BuildTime=${TRAVIS_TAG}"
  - GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X github.com/cj123/assetto-server-manager.BuildTime=${TRAVIS_TAG}"
  - zip -r server-manager_windows_$TRAVIS_TAG.zip server-manager.exe config.yml ../../README.md ../../LICENSE
  - zip -r server-manager_linux_$TRAVIS_TAG.zip server-manager config.yml ../../README.md ../../LICENSE

deploy:
  provider: releases
  api_key: $OAUTH_TOKEN
  file:
    - server-manager_windows_$TRAVIS_TAG.zip
    - server-manager_linux_$TRAVIS_TAG.zip
  skip_cleanup: true
  on:
    tags: true
